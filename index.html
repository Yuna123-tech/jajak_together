<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜‘ë ¥ ê²Œì„: í­íƒ„ í•´ì²´ ë¯¸ì…˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F0E1A;
            color: #E8E8E8;
            transition: background-color 0.5s ease;
        }
        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .card {
            background-color: #1A192D;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            max-width: 90%;
            width: 500px;
            border: 2px solid #28273F;
        }
        input, button, select {
            padding: 1rem;
            border-radius: 0.75rem;
            border: none;
            width: 100%;
            font-size: 1rem;
            background-color: #1A192D;
            color: #C0C0D0;
            outline: none;
        }
        button {
            background-color: #FF5A5A;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 0 #D32F2F;
        }
        button:hover {
            background-color: #D32F2F;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #B71C1C;
        }
        .text-neon {
            font-family: 'Orbitron', sans-serif;
            color: #00E4FF;
            text-shadow: 0 0 5px #00BFFF, 0 0 10px #00BFFF, 0 0 15px #00BFFF;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success-bg {
            background-color: #0A2D0D;
        }
        .fail-bg {
            background-color: #2F0B0B;
        }
        .map-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        .map-cell {
            width: 48px;
            height: 48px;
            background-color: #1A192D;
            border: 1px solid #4F516D;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        .hint-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: #28273F;
            border: 1px solid #4F516D;
            text-shadow: 0 0 3px #fff;
        }
        .modal-card {
            background-color: #1A192D;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
    </style>
    <script type="module">
        // Firebase Configuration
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, collection, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, db, auth;
        let isAuthReady = false;

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        isAuthReady = true;
                        router();
                    });
                } else {
                    console.error('Firebase config is not set. The app will run in a limited, non-collaborative mode.');
                    isAuthReady = true;
                    router();
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        const appContainer = document.getElementById('app');

        const render = (view) => {
            appContainer.innerHTML = '';
            appContainer.appendChild(view);
        };

        // UI for modals (instead of alert)
        const createModal = (message, type) => {
            const modal = document.createElement('dialog');
            modal.className = `fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 rounded-lg shadow-lg`;
            modal.innerHTML = `
                <div class="modal-card p-6 text-center space-y-4 max-w-sm w-full">
                    <p class="text-xl font-bold ${type === 'success' ? 'text-green-400' : 'text-red-400'}">${message}</p>
                    <button class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="this.closest('dialog').close()">ë‹«ê¸°</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.showModal();
        };

        // Helper for shuffling arrays
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        };

        // --- Views ---
        const createLandingView = () => {
            const view = document.createElement('div');
            view.className = 'container';
            view.innerHTML = `
                <div class="card text-center space-y-4">
                    <h1 class="text-3xl font-bold text-neon">í­íƒ„ í•´ì²´ ë¯¸ì…˜</h1>
                    <p class="text-lg opacity-80 mt-2">í˜¼ìì„œëŠ” í­íƒ„ì„ í•´ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë‘ ì›ê³¼ í˜‘ë ¥í•˜ì—¬ ì½”ë“œë¥¼ ì™„ì„±í•˜ì„¸ìš”!</p>
                    <div class="space-y-4 pt-6">
                        <button id="start-teacher-btn">ìƒˆ ë¯¸ì…˜ ì‹œì‘ (ì„ ìƒë‹˜)</button>
                        <p class="text-sm opacity-70">í•™ìƒë“¤ì€ ì…ì¥ ì½”ë“œë¥¼ ì…ë ¥í•˜ì—¬ ì°¸ì—¬í•©ë‹ˆë‹¤.</p>
                        <input type="text" id="join-code-input" placeholder="ì…ì¥ ì½”ë“œ ì…ë ¥ (ì˜ˆ: ABCDEF)" class="mt-4 uppercase">
                        <button id="join-game-btn">ê²Œì„ ì°¸ì—¬í•˜ê¸°</button>
                    </div>
                </div>
            `;
            view.querySelector('#start-teacher-btn').onclick = () => {
                if (isAuthReady) {
                    render(createTeacherSetupView());
                } else {
                    const button = view.querySelector('#start-teacher-btn');
                    button.innerHTML = '<div class="loading-spinner mx-auto"></div>';
                }
            };
            view.querySelector('#join-game-btn').onclick = async () => {
                const joinCode = view.querySelector('#join-code-input').value.trim().toUpperCase();
                if (joinCode.length !== 6) {
                    createModal('ì…ì¥ ì½”ë“œëŠ” 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    return;
                }
                if (isAuthReady) {
                    const q = query(collection(db, `/artifacts/${appId}/public/data/games`), where("joinCode", "==", joinCode));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        createModal('ìœ íš¨í•˜ì§€ ì•Šì€ ì…ì¥ ì½”ë“œì…ë‹ˆë‹¤.', 'error');
                    } else {
                        const gameDoc = querySnapshot.docs[0];
                        const gameId = gameDoc.id;
                        window.location.href = `${window.location.origin}${window.location.pathname}?gameId=${gameId}&joinCode=${joinCode}`;
                    }
                }
            };
            return view;
        };

        const createTeacherSetupView = () => {
            const view = document.createElement('div');
            view.className = 'container';
            view.innerHTML = `
                <div class="card text-center space-y-4">
                    <h2 class="text-2xl font-bold text-neon">ë¯¸ì…˜ ì„¤ì •</h2>
                    <p class="text-sm opacity-80">ê°ˆë“±ì„ í•´ê²°í•˜ê³  í­íƒ„ì„ í•´ì²´í•˜ì„¸ìš”!</p>
                    <div class="space-y-4">
                        <label for="difficulty-select" class="block text-left font-medium">ë‚œì´ë„ ì„ íƒ</label>
                        <select id="difficulty-select" class="bg-gray-700 text-white rounded-lg p-3">
                            <option value="easy">ì‰¬ì›€ (ê°€ì§œ ë‹¨ì„œ)</option>
                            <option value="medium">ë³´í†µ (ëª¨ìˆœëœ ì§€ë„)</option>
                            <option value="hard">ì–´ë ¤ì›€ (ì¶©ëŒí•˜ëŠ” ì•”í˜¸)</option>
                        </select>
                    </div>
                    <div class="space-y-4">
                        <label for="password-input" class="block text-left font-medium">í•´ì²´ ì½”ë“œ (4ìë¦¬ ìˆ«ì/ë‹¨ì–´)</label>
                        <input type="text" id="password-input" placeholder="ì˜ˆ: 4217" class="p-4 rounded-lg">
                    </div>
                    <button id="start-game-btn">ë¯¸ì…˜ ì‹œì‘</button>
                    <div id="game-info" class="space-y-4 hidden">
                        <h3 class="text-xl font-bold text-neon pt-4">ì…ì¥ ì½”ë“œ: <span id="join-code" class="text-white text-3xl font-bold"></span></h3>
                        <p class="text-sm opacity-70">í•™ìƒë“¤ì—ê²Œ ì…ì¥ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. ê°ì ìë™ìœ¼ë¡œ ëª¨ë‘ ì´ ë°°ì •ë©ë‹ˆë‹¤.</p>
                    </div>
                    <div id="game-status-container" class="space-y-4 hidden">
                        <h3 class="text-xl font-bold text-neon pt-4">ë¯¸ì…˜ í˜„í™©</h3>
                        <div id="teams-status-list" class="space-y-4 text-left"></div>
                    </div>
                </div>
            `;

            const passwordInput = view.querySelector('#password-input');
            const difficultySelect = view.querySelector('#difficulty-select');
            const startGameBtn = view.querySelector('#start-game-btn');
            const gameInfoContainer = view.querySelector('#game-info');
            const joinCodeSpan = view.querySelector('#join-code');
            const gameStatusContainer = view.querySelector('#game-status-container');
            const teamsStatusList = view.querySelector('#teams-status-list');
            
            difficultySelect.onchange = () => {
                const difficulty = difficultySelect.value;
                if (difficulty === 'easy' || difficulty === 'medium') {
                    passwordInput.placeholder = "ì˜ˆ: 4217";
                    passwordInput.maxLength = 4;
                    passwordInput.type = "text";
                } else if (difficulty === 'hard') {
                    passwordInput.placeholder = "ì˜ˆ: ë‹¨ì–´4ìë¦¬";
                    passwordInput.maxLength = 4;
                    passwordInput.type = "text";
                }
            };
            
            startGameBtn.onclick = async () => {
                const difficulty = difficultySelect.value;
                const password = passwordInput.value.trim();
                if (password.length !== 4) {
                    createModal('í•´ì²´ ì½”ë“œëŠ” 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    return;
                }
                const gameId = Math.random().toString(36).substring(2, 8);
                const joinCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games`, gameId);
                
                try {
                    startGameBtn.disabled = true;
                    startGameBtn.textContent = 'ë¯¸ì…˜ ìƒì„± ì¤‘...';

                    await setDoc(gameDocRef, {
                        joinCode,
                        difficulty,
                        password,
                        players: [],
                        lastUpdated: serverTimestamp()
                    });

                    startGameBtn.classList.add('hidden');
                    gameInfoContainer.classList.remove('hidden');
                    gameStatusContainer.classList.remove('hidden');
                    joinCodeSpan.textContent = joinCode;

                    onSnapshot(gameDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const gameData = docSnap.data();
                            const players = gameData.players || [];
                            const teams = {};
                            players.forEach(p => {
                                if (!teams[p.teamId]) teams[p.teamId] = { solved: false, lastAttempt: null, players: [] };
                                teams[p.teamId].players.push(p);
                                if(p.solved) teams[p.teamId].solved = true;
                                if(p.lastAttempt) teams[p.teamId].lastAttempt = p.lastAttempt;
                            });

                            teamsStatusList.innerHTML = '';
                            Object.keys(teams).sort().forEach(teamId => {
                                const team = teams[teamId];
                                const statusClass = team.solved ? 'text-green-400' : 'text-red-400';
                                teamsStatusList.innerHTML += `
                                    <div class="p-4 border border-[#4F516D] rounded-lg">
                                        <h4 class="font-bold">ëª¨ë‘  ${teamId}</h4>
                                        <p>ìƒíƒœ: <span class="${statusClass}">${team.solved ? 'ë¯¸ì…˜ ì„±ê³µ!' : 'ì§„í–‰ ì¤‘...'}</span></p>
                                        <p class="text-sm opacity-80">ìµœê·¼ ì‹œë„: ${team.lastAttempt || 'ì—†ìŒ'}</p>
                                        <div class="mt-2 text-sm opacity-70">
                                            ì°¸ì—¬ í•™ìƒ: ${team.players.map(p => `í•™ìƒ ${p.playerIndex + 1}`).join(', ')}
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    });
                } catch (error) {
                    console.error("Error creating game:", error);
                    createModal("ê²Œì„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
                    startGameBtn.disabled = false;
                    startGameBtn.textContent = 'ë¯¸ì…˜ ì‹œì‘';
                }
            };
            return view;
        };

        const createPlayerView = (gameId, joinCode) => {
            const view = document.createElement('div');
            view.className = 'container';
            view.innerHTML = `
                <div class="card text-center space-y-4">
                    <h2 class="text-2xl font-bold text-neon">í­íƒ„ í•´ì²´ ë¯¸ì…˜</h2>
                    <p class="text-lg opacity-80 mt-2">ì…ì¥ ì½”ë“œ: <span class="text-neon">${joinCode}</span></p>
                    <div id="player-status" class="space-y-2 hidden">
                        <p class="text-lg">ë‹¹ì‹ ì€ <span id="team-info" class="text-neon"></span>ì˜ ì¼ì›ì…ë‹ˆë‹¤.</p>
                        <p class="text-lg opacity-80">í˜¼ë€ ì†ì—ì„œ ì§„ì‹¤ì„ ì°¾ì•„ í­íƒ„ì„ í•´ì²´í•˜ì„¸ìš”!</p>
                    </div>
                    <div id="player-hint-container" class="p-6 rounded-lg bg-[#1A192D] my-4 hidden">
                        <p class="text-lg font-bold" id="hint-label">ë‹¹ì‹ ì—ê²Œ ì£¼ì–´ì§„ ë‹¨ì„œ:</p>
                        <div id="hint-content" class="text-4xl font-bold mt-2 text-white overflow-x-auto"></div>
                    </div>
                    <div class="space-y-4 hidden" id="input-container">
                        <label for="team-answer-input" class="block text-left font-medium">ëª¨ë‘ ì›ë“¤ê³¼ í˜‘ë ¥í•˜ì—¬ í•´ì²´ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</label>
                        <input type="text" id="team-answer-input" placeholder="ì „ì²´ 4ìë¦¬ ì½”ë“œ" maxlength="4" class="uppercase p-4">
                    </div>
                    <button id="submit-answer-btn" class="hidden">ì½”ë“œ ì…ë ¥</button>
                    <button id="join-team-btn" class="mt-4">ê²Œì„ì— ì°¸ì—¬í•˜ê¸°</button>
                    <p id="result-message" class="font-bold mt-4"></p>
                </div>
            `;

            const hintContent = view.querySelector('#hint-content');
            const teamAnswerInput = view.querySelector('#team-answer-input');
            const submitBtn = view.querySelector('#submit-answer-btn');
            const resultMessage = view.querySelector('#result-message');
            const joinTeamBtn = view.querySelector('#join-team-btn');
            const playerStatusDiv = view.querySelector('#player-status');
            const hintContainer = view.querySelector('#player-hint-container');
            const inputContainer = view.querySelector('#input-container');
            const hintLabel = view.querySelector('#hint-label');

            const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games`, gameId);
            let assignedTeamId = null;
            let assignedPlayerIndex = null;
            
            const generateEasyHint = (password, playerIndex) => {
                const correctChar = password[playerIndex];
                const otherChars = password.split('').filter((_, i) => i !== playerIndex);
                let fakeChars = [];
                while (fakeChars.length < 2) {
                    const randomChar = Math.floor(Math.random() * 10).toString();
                    if (randomChar !== correctChar && !otherChars.includes(randomChar) && !fakeChars.includes(randomChar)) {
                        fakeChars.push(randomChar);
                    }
                }
                const hintArray = [correctChar, ...fakeChars];
                shuffleArray(hintArray);
                return hintArray.join(', ');
            };

            const generateMediumHint = (playerIndex) => {
                const baseMap = [
                    ['S', 'P', 'Z', 'P'],
                    ['P', 'Z', 'P', 'P'],
                    ['P', 'P', 'P', 'Z'],
                    ['P', 'P', 'E', 'P']
                ];
                const conflictingMap = [
                    ['P', 'S', 'P', 'Z'],
                    ['P', 'P', 'P', 'P'],
                    ['Z', 'P', 'Z', 'P'],
                    ['P', 'E', 'P', 'P']
                ];
                const playerMap = Array.from({length: 4}, () => Array(4).fill(' '));
                const mapToUse = playerIndex % 2 === 0 ? baseMap : conflictingMap;
                const startRow = Math.floor(playerIndex / 2) * 2;
                const startCol = (playerIndex % 2) * 2;
                for(let i=0; i<2; i++) {
                    for(let j=0; j<2; j++) {
                        playerMap[i + startRow][j + startCol] = mapToUse[i + startRow][j + startCol];
                    }
                }
                return playerMap;
            };

            const generateHardHint = (password, playerIndex) => {
                const hints = [
                    `ë‹¨ì„œ 1: í•´ì²´ ì½”ë“œì˜ ${password[0]}ë²ˆì§¸ ê¸€ìëŠ” '${password[0]}'ì…ë‹ˆë‹¤.`,
                    `ë‹¨ì„œ 2: í•´ì²´ ì½”ë“œì˜ ì²« ê¸€ìëŠ” '${password[1]}'ì…ë‹ˆë‹¤.`, // Conflicting
                    `ë‹¨ì„œ 3: í•´ì²´ ì½”ë“œì˜ ${password[2]}ë²ˆì§¸ ê¸€ìëŠ” '${password[2]}'ì…ë‹ˆë‹¤.`,
                    `ë‹¨ì„œ 4: í•´ì²´ ì½”ë“œì˜ ì„¸ ë²ˆì§¸ ê¸€ìëŠ” '${password[3]}'ì…ë‹ˆë‹¤.` // Conflicting
                ];
                return hints[playerIndex];
            };

            const renderHint = (difficulty, hint) => {
                if (difficulty === 'easy') {
                    hintLabel.textContent = `ë‹¹ì‹ ì—ê²Œ ì£¼ì–´ì§„ ë‹¨ì„œ (ì§„ì‹¤ê³¼ ê±°ì§“ì´ ì„ì—¬ ìˆìŠµë‹ˆë‹¤):`;
                    hintContent.innerHTML = `<div class="flex justify-center space-x-2">${hint.split(',').map(h => `<div class="hint-item">${h}</div>`).join('')}</div>`;
                } else if (difficulty === 'medium') {
                    hintLabel.textContent = `ë‹¹ì‹ ì—ê²Œ ì£¼ì–´ì§„ ì§€ë„ ì¡°ê° (íŒ€ì›ì˜ ì¡°ê°ê³¼ ì¶©ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤):`;
                    const mapGrid = document.createElement('div');
                    mapGrid.className = 'map-grid';
                    for (let i = 0; i < 4; i++) {
                        for (let j = 0; j < 4; j++) {
                            const cell = document.createElement('div');
                            cell.className = 'map-cell';
                            if (hint[i][j] === 'S') cell.innerHTML = 'ğŸš¶';
                            if (hint[i][j] === 'E') cell.innerHTML = 'ğŸšª';
                            if (hint[i][j] === 'Z') cell.innerHTML = 'ğŸ§Ÿ';
                            if (hint[i][j] === 'P') cell.innerHTML = 'âœ…';
                            mapGrid.appendChild(cell);
                        }
                    }
                    hintContent.innerHTML = '';
                    hintContent.appendChild(mapGrid);
                } else if (difficulty === 'hard') {
                    hintLabel.textContent = `ë‹¹ì‹ ì—ê²Œ ì£¼ì–´ì§„ ë‹¨ì„œ (ì •ë‹µì€ ë‹¨ í•˜ë‚˜!):`;
                    hintContent.innerHTML = `<div class="text-lg font-normal break-words whitespace-pre-wrap">${hint}</div>`;
                }
            };

            joinTeamBtn.onclick = async () => {
                try {
                    joinTeamBtn.disabled = true;
                    joinTeamBtn.textContent = 'ì°¸ì—¬ ì¤‘...';
                    const docSnap = await getDoc(gameDocRef);
                    if (!docSnap.exists()) {
                        createModal('ê²Œì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì…ì¥ ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.', 'error');
                        joinTeamBtn.disabled = false;
                        joinTeamBtn.textContent = 'ê²Œì„ì— ì°¸ì—¬í•˜ê¸°';
                        return;
                    }

                    const gameData = docSnap.data();
                    const players = gameData.players || [];
                    let assigned = false;
                    for (let t = 1; t <= 4; t++) {
                        const teamPlayers = players.filter(p => p.teamId === t);
                        if (teamPlayers.length < 4) {
                            assignedTeamId = t;
                            assignedPlayerIndex = teamPlayers.length;
                            const newPlayer = {
                                userId: auth.currentUser.uid,
                                teamId: assignedTeamId,
                                playerIndex: assignedPlayerIndex,
                                solved: false
                            };
                            
                            if (gameData.difficulty === 'easy') {
                                newPlayer.hint = generateEasyHint(gameData.password, assignedPlayerIndex);
                            } else if (gameData.difficulty === 'medium') {
                                newPlayer.hint = generateMediumHint(assignedPlayerIndex);
                            } else if (gameData.difficulty === 'hard') {
                                newPlayer.hint = generateHardHint(gameData.password, assignedPlayerIndex);
                            }

                            players.push(newPlayer);
                            await updateDoc(gameDocRef, { players });
                            assigned = true;
                            break;
                        }
                    }

                    if (!assigned) {
                        createModal('ëª¨ë“  íŒ€ì˜ ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒ€ì— ì°¸ì—¬í•˜ì„¸ìš”.', 'error');
                        joinTeamBtn.disabled = false;
                        joinTeamBtn.textContent = 'ê²Œì„ì— ì°¸ì—¬í•˜ê¸°';
                        return;
                    }
                    
                    joinTeamBtn.classList.add('hidden');
                    playerStatusDiv.classList.remove('hidden');
                    hintContainer.classList.remove('hidden');
                    inputContainer.classList.remove('hidden');
                    submitBtn.classList.remove('hidden');
                    view.querySelector('#team-info').textContent = `ëª¨ë‘  ${assignedTeamId}ì˜ í•™ìƒ ${assignedPlayerIndex + 1}`;
                    
                } catch (error) {
                    console.error("Error joining team:", error);
                    createModal("ê²Œì„ ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
                    joinTeamBtn.disabled = false;
                    joinTeamBtn.textContent = 'ê²Œì„ì— ì°¸ì—¬í•˜ê¸°';
                }
            };

            onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    const player = (gameData.players || []).find(p => p.userId === auth.currentUser.uid);
                    
                    if (player) {
                        renderHint(gameData.difficulty, player.hint);

                        if (player.solved) {
                            resultMessage.textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë‘ ì´ ì„±ê³µì ìœ¼ë¡œ ë¯¸ì…˜ì„ ì™„ìˆ˜í–ˆìŠµë‹ˆë‹¤!';
                            resultMessage.className = 'text-green-400 font-bold mt-4';
                            submitBtn.disabled = true;
                            teamAnswerInput.disabled = true;
                            document.body.classList.add('success-bg');
                        } else if (player.lastAttempt !== null && !player.solved) {
                            document.body.classList.add('fail-bg');
                            setTimeout(() => {
                                document.body.classList.remove('fail-bg');
                            }, 1000);
                        }
                    }
                }
            }, (error) => {
                console.error("Error getting game data:", error);
                createModal('ê²Œì„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            });

            submitBtn.onclick = async () => {
                const submittedAnswer = teamAnswerInput.value.trim().toUpperCase();
                if (submittedAnswer.length !== 4) {
                    createModal('ì½”ë“œëŠ” 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'í™•ì¸ ì¤‘...';

                try {
                    const docSnap = await getDoc(gameDocRef);
                    if (docSnap.exists()) {
                        const gameData = docSnap.data();
                        const correctPassword = gameData.password.toUpperCase();
                        const isCorrect = submittedAnswer === correctPassword;

                        if (isCorrect) {
                            resultMessage.textContent = 'ì„±ê³µ! í­íƒ„ í•´ì²´ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!';
                            resultMessage.className = 'text-green-400 font-bold mt-4';
                        } else {
                            resultMessage.textContent = 'ì‹¤íŒ¨! ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                            resultMessage.className = 'text-red-400 font-bold mt-4';
                        }
                        
                        const players = gameData.players.map(p => {
                            if (p.userId === auth.currentUser.uid) {
                                return { ...p, solved: isCorrect, lastAttempt: submittedAnswer };
                            }
                            return p;
                        });

                        await updateDoc(gameDocRef, { players });
                    }
                } catch (error) {
                    console.error("Error submitting answer:", error);
                    createModal('ì½”ë“œ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ì½”ë“œ ì…ë ¥';
                }
            };
            return view;
        };

        const router = () => {
            const params = new URLSearchParams(window.location.search);
            const gameId = params.get('gameId');
            const joinCode = params.get('joinCode');

            if (gameId && joinCode) {
                render(createPlayerView(gameId, joinCode));
            } else {
                render(createLandingView());
            }
        };

        initFirebase();
    </script>
</head>
<body>
    <div id="app"></div>
</body>
</html>
